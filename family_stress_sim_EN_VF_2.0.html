<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Sistema de Estrés Familiar</title>
<style>
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0f1220; color:#f2f4f8; height: 100vh; }
  header { padding: 16px 20px; background: #14172a; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
  h1 { font-size: 18px; margin: 0; }
  .container { display: grid; grid-template-columns: 350px 3fr; gap: 16px; padding: 16px; height: calc(100vh - 80px); }
  .panel { background:#14172a; border:1px solid #23284b; border-radius: 10px; padding: 12px; height: 100%; overflow: auto; }
  .section-title { font-size: 13px; opacity:0.9; margin: 10px 0 6px; text-transform: uppercase; letter-spacing: .06em; }
  .row { display:flex; align-items:center; justify-content:space-between; gap:8px; margin: 8px 0; }
  .row label { font-size: 12px; color:#c7ccf5; }
  input[type=range] { width: 160px; }
  .grid { display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap: 12px; }
  .controls .row button, .toolbar button { background:#2b3166; color:#e6e9ff; border:1px solid #3a4080; padding:8px 10px; border-radius:8px; cursor:pointer; }
  .controls .row button:hover, .toolbar button:hover { background:#343b7a; }
  .toolbar { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .small { font-size: 11px; color:#b9bfe8; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #3a4080; background:#1a1f44; font-size:11px; margin-right:6px; }
  .chart { background:#0b0e1a; border:1px solid #23284b; border-radius:10px; width: 100%; min-height: 600px; }
  #chart { width: 100%; min-height: 600px; }
  .footer { font-size: 11px; color:#aab0de; padding:12px 16px; }
  table { border-collapse: collapse; }
  /* --- custom slider alignment --- */
  .slider-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 6px 0;
  }
  .slider-label {
    font-size: 11px;
    color: #c7ccf5;
    width: 70px;
    flex-shrink: 0;
    text-align: right;
  }
  .slider-small {
    width: 100px;
    flex-shrink: 0;
  }
  .slider-value {
    font-size: 11px;
    min-width: 32px;
    text-align: left;
  }
  /* New styles for day type indicator */
  .day-indicator { margin-top: 8px; font-size: 12px; color: #f2f4f8; }
  .day-active { color: #00ff00; }
  .day-reverting { color: #ffff00; }
  /* Day type buttons */
  .day-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
  .day-buttons button { background:#2b3166; color:#e6e9ff; border:1px solid #3a4080; padding:8px 10px; border-radius:8px; cursor:pointer; }
  .day-buttons button:hover { background:#343b7a; }
  .day-buttons button.active { background:#343b7a; color:#ffffff; }
</style>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="build" content="fresh-1757098222" />

<!-- Existing Code: Redundant style blocks removed -->

  <header>
    <h1>Simulador de Sistema de Estrés Familiar</h1>
  </header>
  <div class="container">
    <div class="panel">
      <div class="section-title">Controles de Simulación</div>
      <div class="row controls">
        <button id="play" type="button">Start</button>
        <button id="pause" type="button">Pause</button>
        <button id="step" type="button">Step</button>
        <button id="reset" type="button">Reset</button>
        <button id="zeroVars" type="button">Zero</button>
      </div>
      <div class="row">
        <label for="speed">Velocidad (ms/paso)</label>
        <input id="speed" type="range" min="10" max="200" step="5" value="100" title="Velocidad en milisegundos por paso"/>
        <span id="speedVal" class="small">100</span>
      </div>
      <div class="section-title">Tipo de Día</div>
      <div class="row">
        <div class="day-buttons">
          <button id="dayNormal" type="button">Normal</button>
          <button id="dayCalm" type="button">Día Calmado</button>
          <button id="dayStormy" type="button">Día Agitado</button>
        </div>
        <div id="dayIndicator" class="day-indicator">Normal</div>
      </div>
      <div class="section-title">External Stress Inflow (0-100)</div>
      <div class="row"><label for="ext_father">Padre</label><input id="ext_father" type="range" min="0" max="100" step="1" value="50"><span id="ext_father_val" class="small">50</span></div>
      <div class="row"><label for="ext_mother">Madre</label><input id="ext_mother" type="range" min="0" max="100" step="1" value="30"><span id="ext_mother_val" class="small">30</span></div>
      <div class="row"><label for="ext_son1">Hijo1</label><input id="ext_son1" type="range" min="0" max="100" step="1" value="30"><span id="ext_son1_val" class="small">30</span></div>
      <div class="row"><label for="ext_son2">Hijo2</label><input id="ext_son2" type="range" min="0" max="100" step="1" value="25"><span id="ext_son2_val" class="small">25</span></div>
      <div class="row"><label for="ext_son3">Hijo3</label><input id="ext_son3" type="range" min="0" max="100" step="1" value="5"><span id="ext_son3_val" class="small">5</span></div>
      <div class="section-title">Healthy Coping Outflow (0-100)</div>
      <div class="row"><label for="cop_father">Padre</label><input id="cop_father" type="range" min="0" max="100" step="1" value="0"><span id="cop_father_val" class="small">0</span></div>
      <div class="row"><label for="cop_mother">Madre</label><input id="cop_mother" type="range" min="0" max="100" step="1" value="30"><span id="cop_mother_val" class="small">30</span></div>
      <div class="row"><label for="cop_son1">Hijo1</label><input id="cop_son1" type="range" min="0" max="100" step="1" value="10"><span id="cop_son1_val" class="small">10</span></div>
      <div class="row"><label for="cop_son2">Hijo2</label><input id="cop_son2" type="range" min="0" max="100" step="1" value="40"><span id="cop_son2_val" class="small">40</span></div>
      <div class="row"><label for="cop_son3">Hijo3</label><input id="cop_son3" type="range" min="0" max="100" step="1" value="30"><span id="cop_son3_val" class="small">30</span></div>
      <div class="section-title">Interconexiones (0-100%)</div>
      <div class="section-title" style="font-size: 11px; margin: 8px 0 4px;">Conexiones del Padre</div>
      <div class="row"><label for="w_father_mother">Padre → Madre</label><input id="w_father_mother" type="range" min="0" max="100" step="1" value="60"><span id="w_father_mother_val" class="small">60</span></div>
      <div class="row"><label for="w_father_son1">Padre → Hijo1</label><input id="w_father_son1" type="range" min="0" max="100" step="1" value="20"><span id="w_father_son1_val" class="small">20</span></div>
      <div class="row"><label for="w_father_son2">Padre → Hijo2</label><input id="w_father_son2" type="range" min="0" max="100" step="1" value="10"><span id="w_father_son2_val" class="small">10</span></div>
      <div class="row"><label for="w_father_son3">Padre → Hijo3</label><input id="w_father_son3" type="range" min="0" max="100" step="1" value="40"><span id="w_father_son3_val" class="small">40</span></div>
      <div class="section-title" style="font-size: 11px; margin: 8px 0 4px;">Conexiones de la Madre</div>
      <div class="row"><label for="w_mother_father">Madre → Padre</label><input id="w_mother_father" type="range" min="0" max="100" step="1" value="50"><span id="w_mother_father_val" class="small">50</span></div>
      <div class="row"><label for="w_mother_son1">Madre → Hijo1</label><input id="w_mother_son1" type="range" min="0" max="100" step="1" value="50"><span id="w_mother_son1_val" class="small">50</span></div>
      <div class="row"><label for="w_mother_son2">Madre → Hijo2</label><input id="w_mother_son2" type="range" min="0" max="100" step="1" value="20"><span id="w_mother_son2_val" class="small">20</span></div>
      <div class="row"><label for="w_mother_son3">Madre → Hijo3</label><input id="w_mother_son3" type="range" min="0" max="100" step="1" value="20"><span id="w_mother_son3_val" class="small">20</span></div>
      <div class="section-title" style="font-size: 11px; margin: 8px 0 4px;">Conexiones de los Hijos</div>
      <div class="row"><label for="w_son1_father">Hijo1 → Padre</label><input id="w_son1_father" type="range" min="0" max="100" step="1" value="10"><span id="w_son1_father_val" class="small">10</span></div>
      <div class="row"><label for="w_son1_mother">Hijo1 → Madre</label><input id="w_son1_mother" type="range" min="0" max="100" step="1" value="30"><span id="w_son1_mother_val" class="small">30</span></div>
      <div class="row"><label for="w_son1_son2">Hijo1 → Hijo2</label><input id="w_son1_son2" type="range" min="0" max="100" step="1" value="0"><span id="w_son1_son2_val" class="small">0</span></div>
      <div class="row"><label for="w_son1_son3">Hijo1 → Hijo3</label><input id="w_son1_son3" type="range" min="0" max="100" step="1" value="40"><span id="w_son1_son3_val" class="small">40</span></div>
      <div class="row"><label for="w_son2_father">Hijo2 → Padre</label><input id="w_son2_father" type="range" min="0" max="100" step="1" value="10"><span id="w_son2_father_val" class="small">10</span></div>
      <div class="row"><label for="w_son2_mother">Hijo2 → Madre</label><input id="w_son2_mother" type="range" min="0" max="100" step="1" value="10"><span id="w_son2_mother_val" class="small">10</span></div>
      <div class="row"><label for="w_son2_son1">Hijo2 → Hijo1</label><input id="w_son2_son1" type="range" min="0" max="100" step="1" value="0"><span id="w_son2_son1_val" class="small">0</span></div>
      <div class="row"><label for="w_son2_son3">Hijo2 → Hijo3</label><input id="w_son2_son3" type="range" min="0" max="100" step="1" value="5"><span id="w_son2_son3_val" class="small">5</span></div>
      <div class="row"><label for="w_son3_father">Hijo3 → Padre</label><input id="w_son3_father" type="range" min="0" max="100" step="1" value="5"><span id="w_son3_father_val" class="small">5</span></div>
      <div class="row"><label for="w_son3_mother">Hijo3 → Madre</label><input id="w_son3_mother" type="range" min="0" max="100" step="1" value="20"><span id="w_son3_mother_val" class="small">20</span></div>
      <div class="row"><label for="w_son3_son1">Hijo3 → Hijo1</label><input id="w_son3_son1" type="range" min="0" max="100" step="1" value="30"><span id="w_son3_son1_val" class="small">30</span></div>
      <div class="row"><label for="w_son3_son2">Hijo3 → Hijo2</label><input id="w_son3_son2" type="range" min="0" max="100" step="1" value="10"><span id="w_son3_son2_val" class="small">10</span></div>
      <div class="section-title">Dimensiones del Tanque</div>
  <div class="row"><label for="father_width">Ancho (Padre)</label><input id="father_width" type="range" min="1" max="99" step="1" value="70"><span id="father_width_val" class="small">70</span></div>
  <div class="row"><label for="father_height">Altura (Padre)</label><input id="father_height" type="range" min="1" max="99" step="1" value="30"><span id="father_height_readout" class="small">30</span></div>
  <div class="row"><label for="mother_width">Ancho (Madre)</label><input id="mother_width" type="range" min="1" max="99" step="1" value="30"><span id="mother_width_val" class="small">30</span></div>
  <div class="row"><label for="mother_height">Altura (Madre)</label><input id="mother_height" type="range" min="1" max="99" step="1" value="70"><span id="mother_height_readout" class="small">70</span></div>
  <div class="row"><label for="son1_width">Ancho (Hijo1)</label><input id="son1_width" type="range" min="1" max="99" step="1" value="80"><span id="son1_width_val" class="small">80</span></div>
  <div class="row"><label for="son1_height">Altura (Hijo1)</label><input id="son1_height" type="range" min="1" max="99" step="1" value="20"><span id="son1_height_readout" class="small">20</span></div>
  <div class="row"><label for="son2_width">Ancho (Hijo2)</label><input id="son2_width" type="range" min="1" max="99" step="1" value="50"><span id="son2_width_val" class="small">50</span></div>
  <div class="row"><label for="son2_height">Altura (Hijo2)</label><input id="son2_height" type="range" min="1" max="99" step="1" value="50"><span id="son2_height_readout" class="small">50</span></div>
  <div class="row"><label for="son3_width">Ancho (Hijo3)</label><input id="son3_width" type="range" min="1" max="99" step="1" value="30"><span id="son3_width_val" class="small">30</span></div>
  <div class="row"><label for="son3_height">Altura (Hijo3)</label><input id="son3_height" type="range" min="1" max="99" step="1" value="70"><span id="son3_height_readout" class="small">70</span></div>
    </div>
    <div class="panel">
      <div class="pill">Niveles</div>
      <div id="chart" class="chart"></div>
    </div>
  </div>
  <div class="footer">Copyright: Servando Fernandez/Stefania Patín (Asesoramiento: Liz Maya)</span></div>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var el = document.getElementById('chart');
  if(!el){
    console.error('contenedor del gráfico no encontrado');
    return;
  }
(function(){
  const chartEl = el;
  const byId = function(id){ return document.getElementById(id); };

  // Estado
  let t = 0;
  let playing = false;
  let timer = null;
  let levels = { mother: 20, father: 20, son1: 20, son2: 20, son3: 20 };  // Comenzar en 20 para crecimiento curvo de ejemplo
  const capacity = { mother: 100, father: 100, son1: 100, son2: 100, son3: 100 };
  let dayType = 'normal';
  let dayEffectTicks = 0; // Contador para efecto temporal del día
  const dayMods = { normal: 1.0, calm: 0.5, stormy: 1.5 };
  const effectDuration = 60; // Ticks para efecto temporal, aumentado a 3x (de 20 a 60)

  function readNumber(id, def){
    const el = byId(id); if(!el) return def; const v = parseFloat(el.value); return isNaN(v) ? def : v;
  }

  function readParams(){
    const w = {
      mother: { mother: 0, father: readNumber('w_mother_father', 0)/100, son1: readNumber('w_mother_son1',0)/100, son2: readNumber('w_mother_son2',0)/100, son3: readNumber('w_mother_son3',0)/100 },
      father: { mother: readNumber('w_father_mother', 0)/100, father: 0, son1: readNumber('w_father_son1',0)/100, son2: readNumber('w_father_son2',0)/100, son3: readNumber('w_father_son3',0)/100 },
      son1:   { mother: readNumber('w_son1_mother', 0)/100, father: readNumber('w_son1_father', 0)/100, son1: 0, son2: readNumber('w_son1_son2',0)/100, son3: readNumber('w_son1_son3',0)/100 },
      son2:   { mother: readNumber('w_son2_mother', 0)/100, father: readNumber('w_son2_father', 0)/100, son1: readNumber('w_son2_son1',0)/100, son2: 0, son3: readNumber('w_son2_son3',0)/100 },
      son3:   { mother: readNumber('w_son3_mother', 0)/100, father: readNumber('w_son3_father', 0)/100, son1: readNumber('w_son3_son1',0)/100, son2: readNumber('w_son3_son2',0)/100, son3: 0 }
    };
    const ext = {
      mother: readNumber('ext_mother', 0),
      father: readNumber('ext_father', 0),
      son1: readNumber('ext_son1', 0),
      son2: readNumber('ext_son2', 0),
      son3: readNumber('ext_son3', 0)
    };
    const cop = {
      mother: readNumber('cop_mother', 0),
      father: readNumber('cop_father', 0),
      son1: readNumber('cop_son1', 0),
      son2: readNumber('cop_son2', 0),
      son3: readNumber('cop_son3', 0)
    };
    const width = {
      mother: Math.max(1, readNumber('mother_width', 1)),
      father: Math.max(1, readNumber('father_width', 1)),
      son1: Math.max(1, readNumber('son1_width', 1)),
      son2: Math.max(1, readNumber('son2_width', 1)),
      son3: Math.max(1, readNumber('son3_width', 1))
    };
    const height = { mother: 100 - width.mother, father: 100 - width.father, son1: 100 - width.son1, son2: 100 - width.son2, son3: 100 - width.son3 };
    return { w: w, ext: ext, cop: cop, width: width, height: height };
  }

  function computeNext(params){
    const dayMultiplier = dayMods[dayType];
    const individual = {};
    ['mother','father','son1','son2','son3'].forEach(function(p){
      individual[p] = params.ext[p] * dayMultiplier - params.cop[p];
    });
    const next = {};
    let totalStress = 0;
    const alpha = 0.05; // Factor de suavizado para curvas más suaves
    ['mother','father','son1','son2','son3'].forEach(function(p){
      let stress_p = individual[p] * (1 + params.height[p] / params.width[p]);
      Object.keys(params.w).forEach(function(q){
        if (q !== p) {
          stress_p += individual[q] * params.w[q][p];
        }
      });
      // Crecimiento curvo: aproximarse al objetivo stress_p con tasa basada en altura/ancho (invertido para aumento más lento cuando ancho > altura)
      const rate = params.height[p] / params.width[p];
      next[p] = Math.max(0, Math.min(capacity[p], levels[p] + (stress_p - levels[p]) * rate * alpha));
      totalStress += stress_p;
    });
    byId('totalStress').textContent = totalStress.toFixed(2);
    return next;
  }

  function appendPoint(tt, vals){
    const update = { x: [], y: [] };
    ['mother','father','son1','son2','son3'].forEach(function(p){ update.x.push([tt]); update.y.push([vals[p]]); }); // eje x en pasos
    Plotly.extendTraces(chartEl, update, [0,1,2,3,4], 500);
  }

  function stepOnce(){
    const params = readParams();
    const next = computeNext(params);
    levels = next;
    t = t + 1;
    appendPoint(t, levels);
    // Manejar efecto temporal del día
    if (dayEffectTicks > 0) {
      dayEffectTicks--;
      if (dayEffectTicks === 0) {
        dayType = 'normal';
        updateDayIndicator();
        updateDayButtons();
      }
    }
  }

  function triggerImmediatePreview(){
    const params = readParams();
    const next = computeNext(params);
    appendPoint(t, next);
  }

    function initChart(){
      try {
        const traces = [
          { x: [0], y: [20], mode: 'lines+markers', name: 'Madre', line: {color: 'red'} },  // Comenzar en 20
          { x: [0], y: [20], mode: 'lines+markers', name: 'Padre', line: {color: 'blue'} },
          { x: [0], y: [20], mode: 'lines+markers', name: 'Hijo 1', line: {color: 'green'} },
          { x: [0], y: [20], mode: 'lines+markers', name: 'Hijo 2', line: {color: 'orange'} },
          { x: [0], y: [20], mode: 'lines+markers', name: 'Hijo 3', line: {color: 'purple'} }
        ];
        const layout = { 
          title: 'Niveles de Estrés', 
          showlegend: true, 
          paper_bgcolor: 'rgba(0,0,0,0)', 
          plot_bgcolor: 'rgba(0,0,0,0)',
          yaxis: { range: [0, 100] }  // Fijar eje y a 0-100
        };
        Plotly.newPlot(chartEl, traces, layout, { displayModeBar: false });
      } catch (e) {
        console.error('initChart falló', e);
      }
    }  function start(){ if(playing) return; playing = true; const speed = readNumber('speed', 100); timer = setInterval(stepOnce, speed); }
  function pause(){ playing = false; if(timer){ clearInterval(timer); timer = null; } }
  function reset(){ pause(); t = 0; levels = { mother:20, father:20, son1:20, son2:20, son3:20 }; dayType = 'normal'; dayEffectTicks = 0; Plotly.purge(chartEl); initChart(); updateHeightReadouts(); updateDayIndicator(); updateDayButtons(); updateReadouts(); triggerImmediatePreview(); }

  function zeroVariables(){
    // Establecer todos los deslizadores a 0 excepto ancho/altura (dimensiones del tanque) y velocidad
    document.querySelectorAll('input[type=range]').forEach(el => {
      if (!el.id.includes('width') && !el.id.includes('height') && el.id !== 'speed') {
        el.value = 0;
      }
    });
    // Establecer niveles a 0
    levels = { mother: 0, father: 0, son1: 0, son2: 0, son3: 0 };
    // Actualizar lecturas de altura y lecturas
    updateHeightReadouts();
    updateReadouts();
    // Reiniciar gráfico con 0s
    Plotly.purge(chartEl);
    const traces = [
      { x: [t], y: [0], mode: 'lines+markers', name: 'Madre', line: {color: 'red'} },
      { x: [t], y: [0], mode: 'lines+markers', name: 'Padre', line: {color: 'blue'} },
      { x: [t], y: [0], mode: 'lines+markers', name: 'Hijo 1', line: {color: 'green'} },
      { x: [t], y: [0], mode: 'lines+markers', name: 'Hijo 2', line: {color: 'orange'} },
      { x: [t], y: [0], mode: 'lines+markers', name: 'Hijo 3', line: {color: 'purple'} }
    ];
    const layout = { 
      title: 'Niveles de Estrés', 
      showlegend: true, 
      paper_bgcolor: 'rgba(0,0,0,0)', 
      plot_bgcolor: 'rgba(0,0,0,0)',
      yaxis: { range: [0, 100] }
    };
    Plotly.newPlot(chartEl, traces, layout, { displayModeBar: false });
    triggerImmediatePreview();
  }

  function updateHeightReadouts(){
    ['mother','father','son1','son2','son3'].forEach(function(id){
      const wEl = byId(id + '_width');
      const span = byId(id + '_height_readout');
      const hEl = byId(id + '_height');
      if(wEl){
        const w = Math.max(1, parseFloat(wEl.value || '1'));
        const h = 100 - w;
        if(span){ span.textContent = h; } // Eliminar decimales finales
        if(hEl){ hEl.value = h; }
      }
    });
  }

  function updateReadouts(){
    // Velocidad
    byId('speedVal').textContent = readNumber('speed', 100);
    // Ext
    ['father','mother','son1','son2','son3'].forEach(p => {
      byId('ext_' + p + '_val').textContent = readNumber('ext_' + p, 0);
    });
    // Cop
    ['father','mother','son1','son2','son3'].forEach(p => {
      byId('cop_' + p + '_val').textContent = readNumber('cop_' + p, 0);
    });
    // W
    const wIds = ['w_father_mother', 'w_mother_father', 'w_father_son1', 'w_father_son2', 'w_father_son3', 'w_mother_son1', 'w_mother_son2', 'w_mother_son3', 'w_son1_father', 'w_son1_mother', 'w_son1_son2', 'w_son1_son3', 'w_son2_father', 'w_son2_mother', 'w_son2_son1', 'w_son2_son3', 'w_son3_father', 'w_son3_mother', 'w_son3_son1', 'w_son3_son2'];
    wIds.forEach(id => {
      const val = readNumber(id, 0);
      byId(id + '_val').textContent = val; // Eliminar % de la pantalla estática
      byId(id).title = val + '%'; // Información sobre herramientas dinámica al pasar el mouse/mover
    });
    // Ancho
    ['father','mother','son1','son2','son3'].forEach(p => {
      byId(p + '_width_val').textContent = readNumber(p + '_width', 1);
    });
  }

  function updateDayIndicator(){
    const indicator = byId('dayIndicator');
    if (!indicator) return;
    if (dayEffectTicks > 0) {
      indicator.textContent = `${dayType.charAt(0).toUpperCase() + dayType.slice(1)} (Activo)`;
      indicator.className = 'day-indicator day-active';
    } else {
      indicator.textContent = 'Normal';
      indicator.className = 'day-indicator';
    }
  }

  function updateDayButtons(){
    byId('dayNormal').classList.toggle('active', dayType === 'normal');
    byId('dayCalm').classList.toggle('active', dayType === 'calm');
    byId('dayStormy').classList.toggle('active', dayType === 'stormy');
  }

  // Conectar controles
  if(byId('play')) byId('play').addEventListener('click', start);
  if(byId('pause')) byId('pause').addEventListener('click', pause);
  if(byId('step')) byId('step').addEventListener('click', stepOnce);
  if(byId('reset')) byId('reset').addEventListener('click', reset);
  if(byId('zeroVars')) byId('zeroVars').addEventListener('click', zeroVariables);
  if(byId('dayNormal')) byId('dayNormal').addEventListener('click', function(){
    dayType = 'normal';
    dayEffectTicks = 0;
    updateDayIndicator();
    updateDayButtons();
    triggerImmediatePreview();
  });
  if(byId('dayCalm')) byId('dayCalm').addEventListener('click', function(){
    dayType = 'calm';
    dayEffectTicks = effectDuration;
    updateDayIndicator();
    updateDayButtons();
    triggerImmediatePreview();
  });
  if(byId('dayStormy')) byId('dayStormy').addEventListener('click', function(){
    dayType = 'stormy';
    dayEffectTicks = effectDuration;
    updateDayIndicator();
    updateDayButtons();
    triggerImmediatePreview();
  });

  // Cualquier entrada de rango activa vista previa inmediata
  document.querySelectorAll('input[type=range]').forEach(function(el){
    el.addEventListener('input', function(){ updateHeightReadouts(); updateReadouts(); triggerImmediatePreview(); });
    el.addEventListener('change', function(){ updateHeightReadouts(); updateReadouts(); triggerImmediatePreview(); });
  });

  // Inicializar
  updateHeightReadouts();
  updateDayIndicator();
  updateDayButtons();
  updateReadouts();
  initChart();
  // Agregar datos iniciales de simulación para que el gráfico no esté vacío
  for(let i=0;i<20;i++) stepOnce();
})();
});
</script>
</html>